<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ApplyTrack ‚Äì Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-muted: #e5e7eb;
      --sidebar-bg: #020617;
      --sidebar-border: #111827;
      --card-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --primary: #3b82f6;
      --primary-soft: rgba(59,130,246,0.12);
      --primary-dark: #2563eb;
      --border: #e5e7eb;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-soft: 0 8px 24px rgba(15,23,42,0.10);
      --shadow-subtle: 0 2px 8px rgba(15,23,42,0.06);
      --transition-fast: 0.18s ease-out;
    }
    [data-theme="dark"] {
      --bg: #020617;
      --bg-muted: #020617;
      --sidebar-bg: #020617;
      --sidebar-border: #111827;
      --card-bg: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #3b82f6;
      --primary-soft: rgba(59,130,246,0.16);
      --primary-dark: #60a5fa;
      --border: #1f2937;
      --danger: #f87171;
      --success: #4ade80;
      --warning: #fbbf24;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
      --shadow-subtle: 0 2px 10px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e5e7eb 0, var(--bg) 45%, var(--bg) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .app-shell {
      display: grid;
      grid-template-columns: 260px minmax(0,1fr);
      width: 100%;
      min-height: 100vh;
    }

    @media (max-width: 900px) {
      .app-shell {
        grid-template-columns: 0 minmax(0,1fr);
      }
      .sidebar {
        position: fixed;
        inset: 0;
        max-width: 240px;
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        z-index: 40;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.5);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
        z-index: 30;
      }
      .sidebar-backdrop.visible {
        opacity: 1;
        pointer-events: auto;
      }
      .topbar-left .menu-toggle {
        display: inline-flex;
      }
    }

    .sidebar-backdrop {
      display: none;
    }
    @media (max-width: 900px) {
      .sidebar-backdrop {
        display: block;
      }
    }

    .sidebar {
      background: radial-gradient(circle at top, #020617 0, var(--sidebar-bg) 45%, #020617 100%);
      border-right: 1px solid var(--sidebar-border);
      padding: 16px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #e5e7eb;
    }
    .logo-mark {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 0, #3b82f6 0, #1e40af 40%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
      box-shadow: 0 8px 22px rgba(37,99,235,0.7);
    }
    .logo-text-main {
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 15px;
    }
    .logo-text-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .sidebar-section-label {
      margin-top: 12px;
      margin-bottom: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      color: #d1d5db;
      text-decoration: none;
      font-size: 13px;
      background: transparent;
      border: 1px solid transparent;
      transition: background var(--transition-fast), border-color var(--transition-fast), transform 0.1s ease;
    }
    .nav-item a span.icon {
      font-size: 15px;
      width: 18px;
      text-align: center;
    }
    .nav-item a:hover {
      background: rgba(31,41,55,0.92);
      border-color: rgba(55,65,81,1);
      transform: translateY(-1px);
    }
    .nav-item a.active {
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      border-color: transparent;
      color: #f9fafb;
      box-shadow: 0 10px 25px rgba(37,99,235,0.65);
    }

    .sidebar-bottom {
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px solid rgba(55,65,81,0.8);
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
      color: #9ca3af;
    }
    .sidebar-pill {
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }
    .sidebar-pill span.badge {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34,197,94,0.16);
      color: #bbf7d0;
      font-size: 10px;
    }

    .main-area {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
      background: linear-gradient(to right, rgba(248,250,252,0.88), rgba(248,250,252,0.88));
      position: sticky;
      top: 0;
      z-index: 10;
    }
    [data-theme="dark"] .topbar {
      background: linear-gradient(to right, rgba(15,23,42,0.9), rgba(15,23,42,0.9));
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .topbar-left h1 {
      font-size: 18px;
      margin: 0;
    }
    .topbar-left .subtitle {
      font-size: 12px;
      color: var(--muted);
    }
    .menu-toggle {
      display: none;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toggle {
      font-size: 12px;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .user-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(248,250,252,0.8);
      font-size: 12px;
    }
    [data-theme="dark"] .user-chip {
      background: rgba(15,23,42,0.9);
    }
    .user-avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: white;
      font-weight: 600;
    }
    .logout-btn {
      font-size: 12px;
      padding: 6px 9px;
      border-radius: 999px;
      border: none;
      background: rgba(248,113,113,0.1);
      color: var(--danger);
      cursor: pointer;
    }

    .page {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .welcome-section {
      margin-bottom: 28px;
      padding: 24px;
      background: linear-gradient(135deg, var(--primary), #6366f1);
      border-radius: var(--radius-lg);
      color: white;
      box-shadow: 0 10px 30px rgba(59,130,246,0.3);
      position: relative;
      overflow: hidden;
    }
    
    .welcome-section::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .welcome-content {
      position: relative;
      z-index: 1;
    }

    .welcome-section h2 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;
    }

    .welcome-section p {
      margin: 0;
      font-size: 14px;
      opacity: 0.95;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-subtle);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), #6366f1);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-soft);
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 12px;
    }

    .stat-icon.blue { background: rgba(59,130,246,0.15); }
    .stat-icon.green { background: rgba(34,197,94,0.15); }
    .stat-icon.yellow { background: rgba(251,191,36,0.15); }
    .stat-icon.purple { background: rgba(168,85,247,0.15); }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
      line-height: 1;
    }

    .stat-change {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    .grid-main {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 1100px) {
      .grid-main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .card-header .subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .card:hover {
      box-shadow: 0 14px 40px rgba(15,23,42,0.18);
      transform: translateY(-2px);
      transition: box-shadow var(--transition-fast), transform var(--transition-fast);
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .action-btn {
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      text-decoration: none;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .action-btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-subtle);
    }

    .action-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--primary-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .action-content h4 {
      margin: 0 0 2px;
      font-size: 14px;
      font-weight: 600;
    }

    .action-content p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .timeline-item {
      padding: 12px 0;
      border-left: 2px solid var(--border);
      padding-left: 16px;
      margin-left: 8px;
      position: relative;
    }

    .timeline-item::before {
      content: "";
      position: absolute;
      left: -6px;
      top: 16px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
      border: 2px solid var(--card-bg);
    }

    .timeline-item.overdue::before {
      background: var(--danger);
    }

    .timeline-date {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .timeline-content {
      font-size: 13px;
      font-weight: 500;
    }

    .timeline-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-muted);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #6366f1);
      border-radius: 999px;
      transition: width 0.5s ease;
    }

    canvas {
      width: 100% !important;
      max-height: 250px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state p {
      margin: 0 0 16px;
      font-size: 14px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <div class="app-shell">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo" style="text-decoration: none; color: inherit;">
          <div class="logo-mark">AT</div>
          <div>
            <div class="logo-text-main">ApplyTrack</div>
            <div class="logo-text-sub">Job search command centre</div>
          </div>
        </a>
      </div>

      <div>
        <div class="sidebar-section-label">Main</div>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="dashboard.html" class="active">
              <span class="icon">üìä</span><span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="applications.html">
              <span class="icon">üìã</span><span>Applications</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="board.html">
              <span class="icon">üóÇ</span><span>Board</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="interviews.html">
              <span class="icon">üé§</span><span>Interviews</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="notes.html">
              <span class="icon">üìù</span><span>All Notes</span>
            </a>
          </li>
        </ul>
      </div>

      <div>
        <div class="sidebar-section-label">Coming soon</div>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="#" onclick="event.preventDefault();">
              <span class="icon">üß†</span>
              <span>AI Coach</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" onclick="event.preventDefault();">
              <span class="icon">‚öôÔ∏è</span>
              <span>Settings</span>
            </a>
          </li>
        </ul>
      </div>

      <div class="sidebar-bottom">
        <div class="sidebar-pill">
          <span>Dashboard</span>
          <span class="badge">Overview</span>
        </div>
        <div style="font-size: 11px;">
          Your command center for tracking applications, interviews, and progress.
        </div>
      </div>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button class="menu-toggle" id="menuToggle">‚ò∞</button>
          <div>
            <h1>Dashboard</h1>
            <div class="subtitle">Your job search at a glance</div>
          </div>
        </div>
        <div class="topbar-right">
          <div class="toggle" id="themeToggle">üåô Dark</div>
          <div class="user-chip" id="userChip">
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userEmail">Loading...</span>
          </div>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </header>

      <main class="page">
        <div class="welcome-section">
          <div class="welcome-content">
            <h2 id="welcomeTitle">Welcome back!</h2>
            <p id="welcomeSubtitle">Here's what's happening with your job search today</p>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue">üìä</div>
            <div class="stat-label">Total Applications</div>
            <div class="stat-value" id="totalApps">0</div>
            <div class="stat-change" id="appsChange">
              <span>‚Äî</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon yellow">üé§</div>
            <div class="stat-label">Active Interviews</div>
            <div class="stat-value" id="totalInterviews">0</div>
            <div class="stat-change">
              <span id="interviewsChange">‚Äî</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon green">‚úÖ</div>
            <div class="stat-label">Offers Received</div>
            <div class="stat-value" id="totalOffers">0</div>
            <div class="stat-change positive">
              <span id="offersChange">‚Äî</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon purple">üìà</div>
            <div class="stat-label">Success Rate</div>
            <div class="stat-value" id="offerRate">0%</div>
            <div class="stat-change">
              <span id="rateChange">Offers / Applications</span>
            </div>
          </div>
        </div>

        <div class="quick-actions">
          <a href="applications.html" class="action-btn">
            <div class="action-icon">‚ûï</div>
            <div class="action-content">
              <h4>Add Application</h4>
              <p>Log a new job opportunity</p>
            </div>
          </a>

          <a href="board.html" class="action-btn">
            <div class="action-icon">üóÇ</div>
            <div class="action-content">
              <h4>View Board</h4>
              <p>Manage your pipeline</p>
            </div>
          </a>

          <a href="interviews.html" class="action-btn">
            <div class="action-icon">üìù</div>
            <div class="action-content">
              <h4>Interview Prep</h4>
              <p>Review your notes</p>
            </div>
          </a>
        </div>

        <div class="grid-main">
          <div class="card">
            <div class="card-header">
              <div>
                <h3>Application Activity</h3>
                <div class="subtitle">Your submission trend over time</div>
              </div>
            </div>
            <canvas id="appsPerMonthChart"></canvas>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <h3>Pipeline Status</h3>
                <div class="subtitle">Current distribution</div>
              </div>
            </div>
            <canvas id="statusPieChart"></canvas>
          </div>
        </div>

        <div class="grid-main">
          <div class="card">
            <div class="card-header">
              <div>
                <h3>Upcoming Follow-ups</h3>
                <div class="subtitle">Stay on top of your deadlines</div>
              </div>
            </div>
            <div id="timelineContainer"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <h3>Quick Insights</h3>
                <div class="subtitle">Track your momentum</div>
              </div>
            </div>
            <div style="padding: 12px 0;">
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 500;">Response Rate</span>
                  <span style="font-size: 13px; color: var(--muted);" id="responseRate">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="responseProgress" style="width: 0%"></div>
                </div>
              </div>

              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 500;">Interview Conversion</span>
                  <span style="font-size: 13px; color: var(--muted);" id="interviewConversion">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="interviewProgress" style="width: 0%"></div>
                </div>
              </div>

              <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 500;">Offer Conversion</span>
                  <span style="font-size: 13px; color: var(--muted);" id="offerConversion">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="offerProgress" style="width: 0%"></div>
                </div>
              </div>

              <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">This Week</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 13px;">Applications</span>
                  <span style="font-size: 13px; font-weight: 600;" id="weekApps">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="font-size: 13px;">Avg. per day</span>
                  <span style="font-size: 13px; font-weight: 600;" id="avgPerDay">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://xktmvjnzjeeoxsreggpg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhrdG12am56amVlb3hzcmVnZ3BnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTEzMjMsImV4cCI6MjA4Mzk2NzMyM30.RHfnwflwiZ4KwDNLC_H6WpoekvHWAQeau5m8bTod2IM";
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let appsPerMonthChart, statusPieChart;

    // Theme toggle
    const themeToggle = document.getElementById("themeToggle");
    const storedTheme = localStorage.getItem("applytrack-theme") || "dark";
    document.documentElement.setAttribute("data-theme", storedTheme);
    themeToggle.textContent = storedTheme === "dark" ? "üåô Dark" : "‚òÄÔ∏è Light";

    themeToggle.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("applytrack-theme", next);
      themeToggle.textContent = next === "dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
      
      if (appsPerMonthChart) {
        updateChartColors();
      }
    });

    // Mobile menu
    const sidebar = document.getElementById("sidebar");
    const sidebarBackdrop = document.getElementById("sidebarBackdrop");
    const menuToggle = document.getElementById("menuToggle");

    if (menuToggle) {
      menuToggle.addEventListener("click", () => {
        sidebar.classList.add("open");
        sidebarBackdrop.classList.add("visible");
      });
    }
    if (sidebarBackdrop) {
      sidebarBackdrop.addEventListener("click", () => {
        sidebar.classList.remove("open");
        sidebarBackdrop.classList.remove("visible");
      });
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    // Initialize
    (async () => {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = "login.html";
        return;
      }
      currentUser = data.session.user;
      
      if (currentUser.email) {
        document.getElementById("userEmail").textContent = currentUser.email;
        document.getElementById("userAvatar").textContent = currentUser.email[0].toUpperCase();
        
        const firstName = currentUser.email.split('@')[0].split('.')[0];
        document.getElementById("welcomeTitle").textContent = `Welcome back, ${firstName.charAt(0).toUpperCase() + firstName.slice(1)}!`;
      }

      await loadDashboard();
    })();

    async function loadDashboard() {
      const { data, error } = await supabase
        .from("applications")
        .select("*")
        .eq("user_id", currentUser.id);

      if (error) {
        console.error(error);
        return;
      }

      const applications = data || [];
      
      updateStats(applications);
      buildCharts(applications);
      buildTimeline(applications);
      updateInsights(applications);
    }

    function updateStats(applications) {
      const total = applications.length;
      const interviews = applications.filter(a => a.status === "Interview").length;
      const offers = applications.filter(a => a.status === "Offer").length;
      const rate = total > 0 ? ((offers / total) * 100).toFixed(1) : 0;

      document.getElementById("totalApps").textContent = total;
      document.getElementById("totalInterviews").textContent = interviews;
      document.getElementById("totalOffers").textContent = offers;
      document.getElementById("offerRate").textContent = rate + "%";

      // Calculate this week's stats
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      
      const thisWeek = applications.filter(a => {
        if (!a.created_at) return false;
        return new Date(a.created_at) > oneWeekAgo;
      });

      document.getElementById("weekApps").textContent = thisWeek.length;
      document.getElementById("avgPerDay").textContent = (thisWeek.length / 7).toFixed(1);
    }

    function updateInsights(applications) {
      const total = applications.length;
      if (total === 0) return;

      const responded = applications.filter(a => a.status !== "To Apply" && a.status !== "Applied").length;
      const interviews = applications.filter(a => a.status === "Interview").length;
      const offers = applications.filter(a => a.status === "Offer").length;

      const responseRate = ((responded / total) * 100).toFixed(1);
      const interviewRate = total > 0 ? ((interviews / total) * 100).toFixed(1) : 0;
      const offerRate = total > 0 ? ((offers / total) * 100).toFixed(1) : 0;

      document.getElementById("responseRate").textContent = responseRate + "%";
      document.getElementById("responseProgress").style.width = responseRate + "%";

      document.getElementById("interviewConversion").textContent = interviewRate + "%";
      document.getElementById("interviewProgress").style.width = interviewRate + "%";

      document.getElementById("offerConversion").textContent = offerRate + "%";
      document.getElementById("offerProgress").style.width = offerRate + "%";
    }

    function buildCharts(applications) {
      buildAppsChart(applications);
      buildStatusChart(applications);
    }

    function getCssVar(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function buildAppsChart(applications) {
      const counts = {};
      applications.forEach(app => {
        if (!app.created_at) return;
        const d = new Date(app.created_at);
        const key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
        counts[key] = (counts[key] || 0) + 1;
      });

      const labels = Object.keys(counts).sort().slice(-6);
      const values = labels.map(k => counts[k]);

      const ctx = document.getElementById("appsPerMonthChart").getContext("2d");
      if (appsPerMonthChart) appsPerMonthChart.destroy();

      appsPerMonthChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Applications",
            data: values,
            backgroundColor: "rgba(59,130,246,0.7)",
            borderRadius: 8,
            maxBarThickness: 50
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: getCssVar("--muted") },
              grid: { display: false }
            },
            y: {
              ticks: { color: getCssVar("--muted"), precision: 0 },
              grid: { color: "rgba(148,163,184,0.2)" },
              beginAtZero: true
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function buildStatusChart(applications) {
      const statuses = ["Applied", "Interview", "Offer", "Rejected"];
      const counts = statuses.map(s => applications.filter(a => a.status === s).length);

      const ctx = document.getElementById("statusPieChart").getContext("2d");
      if (statusPieChart) statusPieChart.destroy();

      statusPieChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: statuses,
          datasets: [{
            data: counts,
            backgroundColor: [
              "rgba(59,130,246,0.85)",
              "rgba(251,191,36,0.85)",
              "rgba(34,197,94,0.85)",
              "rgba(248,113,113,0.85)"
            ],
            borderWidth: 2,
            borderColor: getCssVar("--card-bg")
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "65%",
          plugins: {
            legend: {
              position: "bottom",
              labels: { 
                color: getCssVar("--muted"),
                usePointStyle: true,
                padding: 15
              }
            }
          }
        }
      });
    }

    function updateChartColors() {
      if (appsPerMonthChart) {
        appsPerMonthChart.options.scales.x.ticks.color = getCssVar("--muted");
        appsPerMonthChart.options.scales.y.ticks.color = getCssVar("--muted");
        appsPerMonthChart.update();
      }
      if (statusPieChart) {
        statusPieChart.options.plugins.legend.labels.color = getCssVar("--muted");
        statusPieChart.data.datasets[0].borderColor = getCssVar("--card-bg");
        statusPieChart.update();
      }
    }

    function buildTimeline(applications) {
      const container = document.getElementById("timelineContainer");
      const today = new Date();
      today.setHours(0,0,0,0);

      const upcoming = applications
        .filter(a => {
          if (!a.follow_up_date || a.status === "Offer" || a.status === "Rejected") return false;
          const followUp = new Date(a.follow_up_date);
          followUp.setHours(0,0,0,0);
          return followUp >= today;
        })
        .sort((a, b) => new Date(a.follow_up_date) - new Date(b.follow_up_date))
        .slice(0, 5);

      const overdue = applications
        .filter(a => {
          if (!a.follow_up_date || a.status === "Offer" || a.status === "Rejected") return false;
          const followUp = new Date(a.follow_up_date);
          followUp.setHours(0,0,0,0);
          return followUp < today;
        })
        .sort((a, b) => new Date(a.follow_up_date) - new Date(b.follow_up_date));

      if (overdue.length === 0 && upcoming.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÖ</div>
            <p>No follow-ups scheduled</p>
            <a href="applications.html" class="btn-primary">Add Follow-ups</a>
          </div>
        `;
        return;
      }

      container.innerHTML = "";

      overdue.forEach(app => {
        const item = document.createElement("div");
        item.className = "timeline-item overdue";
        const date = new Date(app.follow_up_date);
        item.innerHTML = `
          <div class="timeline-date">Overdue - ${date.toLocaleDateString()}</div>
          <div class="timeline-content">${app.company}</div>
          <div class="timeline-meta">${app.next_action || "Follow up needed"}</div>
        `;
        container.appendChild(item);
      });

      upcoming.forEach(app => {
        const item = document.createElement("div");
        item.className = "timeline-item";
        const date = new Date(app.follow_up_date);
        const isToday = date.getTime() === today.getTime();
        item.innerHTML = `
          <div class="timeline-date">${isToday ? "Today" : date.toLocaleDateString()}</div>
          <div class="timeline-content">${app.company}</div>
          <div class="timeline-meta">${app.next_action || "Follow up"}</div>
        `;
        container.appendChild(item);
      });
    }
  </script>

