<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ApplyTrack ‚Äì Interview Center</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    /* -----------------------------------------------------------------
       1. EXACT CSS FROM DASHBOARD.HTML
    ----------------------------------------------------------------- */
    :root {
      --bg: #f3f4f6;
      --bg-muted: #e5e7eb;
      --sidebar-bg: #020617;
      --sidebar-border: #111827;
      --card-bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --primary: #3b82f6;
      --primary-soft: rgba(59,130,246,0.12);
      --primary-dark: #2563eb;
      --border: #e5e7eb;
      --danger: #ef4444;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-soft: 0 8px 24px rgba(15,23,42,0.10);
      --shadow-subtle: 0 2px 8px rgba(15,23,42,0.06);
      --transition-fast: 0.18s ease-out;
    }
    [data-theme="dark"] {
      --bg: #020617;
      --bg-muted: #020617;
      --sidebar-bg: #020617;
      --sidebar-border: #111827;
      --card-bg: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #3b82f6;
      --primary-soft: rgba(59,130,246,0.16);
      --primary-dark: #60a5fa;
      --border: #1f2937;
      --danger: #f97373;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
      --shadow-subtle: 0 2px 10px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e5e7eb 0, var(--bg) 45%, var(--bg) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      transition: background 0.3s ease, color 0.3s ease;
      overflow: hidden; 
    }

    .app-shell {
      display: grid;
      grid-template-columns: 260px minmax(0,1fr);
      width: 100%;
      height: 100vh;
    }

    @media (max-width: 900px) {
      .app-shell { grid-template-columns: 0 minmax(0,1fr); }
      .sidebar { position: fixed; inset: 0; transform: translateX(-100%); z-index: 40; transition: transform 0.25s; }
      .sidebar.open { transform: translateX(0); }
      .sidebar-backdrop { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 30; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
      .sidebar-backdrop.visible { opacity: 1; pointer-events: auto; }
      .menu-toggle { display: inline-flex; }
    }
    .sidebar-backdrop { display: none; }

    /* SIDEBAR */
    .sidebar {
      background: radial-gradient(circle at top, #020617 0, var(--sidebar-bg) 45%, #020617 100%);
      border-right: 1px solid var(--sidebar-border);
      padding: 16px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; color: #e5e7eb; }
    .logo-mark {
      width: 28px; height: 28px; border-radius: 10px;
      background: radial-gradient(circle at 20% 0, #3b82f6 0, #1e40af 40%, #0f172a 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 700; box-shadow: 0 8px 22px rgba(37,99,235,0.7);
    }
    .logo-text-main { font-weight: 600; letter-spacing: 0.03em; font-size: 15px; }
    .logo-text-sub { font-size: 11px; color: #9ca3af; }
    .sidebar-section-label { margin-top: 12px; margin-bottom: 6px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: #6b7280; }
    .nav-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; }
    .nav-item a {
      display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 999px;
      color: #d1d5db; text-decoration: none; font-size: 13px;
      transition: all 0.2s; border: 1px solid transparent;
    }
    .nav-item a:hover { background: rgba(31,41,55,0.92); border-color: rgba(55,65,81,1); transform: translateY(-1px); }
    .nav-item a.active {
      background: linear-gradient(135deg, #3b82f6, #6366f1); border-color: transparent;
      color: #f9fafb; box-shadow: 0 10px 25px rgba(37,99,235,0.65);
    }
    .sidebar-bottom { margin-top: auto; padding-top: 8px; border-top: 1px solid rgba(55,65,81,0.8); display: flex; flex-direction: column; gap: 8px; font-size: 12px; color: #9ca3af; }
    .sidebar-pill {
      padding: 6px 8px; border-radius: 999px; background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9); display: flex; justify-content: space-between; align-items: center; font-size: 11px;
    }
    .sidebar-pill span.badge { padding: 2px 6px; border-radius: 999px; background: rgba(168,85,247,0.2); color: #e9d5ff; font-size: 10px; }

    /* MAIN AREA & TOPBAR */
    .main-area { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    .topbar {
      display: flex; justify-content: space-between; align-items: center; padding: 12px 24px;
      border-bottom: 1px solid var(--border); backdrop-filter: blur(12px);
      background: linear-gradient(to right, rgba(248,250,252,0.88), rgba(248,250,252,0.88));
      z-index: 10;
    }
    [data-theme="dark"] .topbar { background: linear-gradient(to right, rgba(15,23,42,0.9), rgba(15,23,42,0.9)); }
    .topbar-left { display: flex; align-items: center; gap: 10px; }
    .topbar-left h1 { font-size: 18px; margin: 0; }
    .topbar-left .subtitle { font-size: 12px; color: var(--muted); }
    .menu-toggle { display: none; border-radius: 999px; border: 1px solid var(--border); padding: 4px 8px; background: transparent; cursor: pointer; font-size: 14px; }
    
    .topbar-right { display: flex; align-items: center; gap: 10px; }
    .toggle { font-size: 12px; cursor: pointer; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); background: transparent; display: flex; align-items: center; gap: 6px; }
    .user-chip { display: flex; align-items: center; gap: 8px; padding: 4px 9px; border-radius: 999px; border: 1px solid var(--border); background: rgba(248,250,252,0.8); font-size: 12px; }
    [data-theme="dark"] .user-chip { background: rgba(15,23,42,0.9); }
    .user-avatar { width: 22px; height: 22px; border-radius: 999px; background: linear-gradient(135deg, #3b82f6, #22c55e); display: flex; align-items: center; justify-content: center; font-size: 11px; color: white; font-weight: 600; }
    .logout-btn { font-size: 12px; padding: 6px 9px; border-radius: 999px; border: none; background: rgba(248,113,113,0.1); color: var(--danger); cursor: pointer; }

    /* -----------------------------------------------------------------
       2. INTERVIEW CENTER SPECIFIC LAYOUT (3-Column Grid)
    ----------------------------------------------------------------- */
    .page {
      padding: 20px;
      flex: 1;
      overflow: hidden; 
      display: flex;
      flex-direction: column;
    }

    .interview-grid {
      display: grid;
      grid-template-columns: 1.6fr 1fr 1fr; /* Left is largest for notes */
      gap: 16px;
      flex: 1;
      height: 100%;
      min-height: 0;
    }

    .panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(var(--card-bg), 0.5);
    }
    .panel-header h3 { margin: 0; font-size: 14px; font-weight: 600; }
    .status-text { font-size: 11px; color: var(--muted); }

    /* COLUMN 1: NOTES (LARGE) */
    .notes-container { flex: 1; display: flex; flex-direction: column; position: relative; }
    #notes-textarea {
      flex: 1;
      width: 100%;
      border: none;
      padding: 20px;
      background: transparent;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      outline: none;
    }
    .save-bar {
      padding: 8px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      background: rgba(148,163,184,0.05);
    }
    .btn-primary {
      background: var(--primary); color: white; border: none; padding: 6px 16px;
      border-radius: 999px; font-size: 12px; font-weight: 600; cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary:hover { background: var(--primary-dark); }

    /* COLUMN 2: INTERVIEW LIST */
    .list-container { flex: 1; overflow-y: auto; padding: 12px; }
    .iv-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .iv-card:hover { border-color: var(--primary); transform: translateY(-2px); }
    .iv-card.active {
      background: var(--primary-soft);
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
    }
    .iv-company { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .iv-role { font-size: 12px; color: var(--muted); }
    .iv-meta { font-size: 10px; margin-top: 6px; display: flex; gap: 6px; color: var(--muted); }

    /* COLUMN 3: AI CHAT */
    .chat-container { flex: 1; display: flex; flex-direction: column; }
    .chat-history { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .bubble { padding: 10px 14px; border-radius: 12px; font-size: 13px; max-width: 90%; line-height: 1.4; }
    .bubble.ai { background: var(--bg); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 2px; color: var(--text); }
    .bubble.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    
    .chat-input-area { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 13px; outline: none; }
    .chat-input:focus { border-color: var(--primary); }

  </style>
</head>
<body>
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <div class="app-shell">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
  <a href="homepage.html" class="sidebar-logo" style="text-decoration: none; color: inherit;">
    <div class="logo-mark">AT</div>
    <div>
      <div class="logo-text-main">ApplyTrack</div>
      <div class="logo-text-sub">Job search command centre</div>
    </div>
  </a>
</div>

      <div>
        <div class="sidebar-section-label">Main</div>
               <ul class="nav-list">
  <li class="nav-item">
    <a href="dashboard.html">
      <span class="icon">üìä</span><span>Dashboard</span>
    </a>
  </li>
  <li class="nav-item">
    <a href="applications.html">
      <span class="icon">üìã</span><span>Applications</span>
    </a>
  </li>
  <li class="nav-item">
    <a href="board.html">
      <span class="icon">üóÇ</span><span>Board</span>
    </a>
  </li>
  <li class="nav-item">
    <a href="interviews.html">
      <span class="icon">üé§</span><span>Interviews</span>
    </a>
  </li>
  <li class="nav-item">
    <a href="notes.html">
      <span class="icon">üìù</span><span>All Notes</span>
    </a>
  </li>
</ul>
      </div>

      <div>
        <div class="sidebar-section-label">Coming soon</div>
        <ul class="nav-list">
          <li class="nav-item"><a href="#"><span class="icon">üß†</span><span>AI Coach</span></a></li>
          <li class="nav-item"><a href="#"><span class="icon">‚öôÔ∏è</span><span>Settings</span></a></li>
        </ul>
      </div>

      <div class="sidebar-bottom">
        <div class="sidebar-pill">
          <span>Interview Mode</span>
          <span class="badge">Live</span>
        </div>
        <div style="font-size: 11px;">Track notes & prep for active interviews here.</div>
      </div>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button class="menu-toggle" id="menuToggle">‚ò∞</button>
          <div>
            <h1>Interview Center</h1>
            <div class="subtitle" id="active-header-sub">Select an application to start notes</div>
          </div>
        </div>
        <div class="topbar-right">
          <div class="toggle" id="themeToggle">üåô Dark</div>
          <div class="user-chip" id="userChip">
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userEmail">Loading...</span>
          </div>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </header>

      <main class="page">
        <div class="interview-grid">
          
          <section class="panel">
            <div class="panel-header">
              <h3>Interview Notes</h3>
              <div class="status-text" id="notes-status">No file selected</div>
            </div>
            <div class="notes-container">
              <textarea id="notes-textarea" placeholder="1. Select an interview from the middle column.&#10;2. Start typing your research, questions, or answers.&#10;3. Click Save."></textarea>
              <div class="save-bar">
                <span id="save-feedback" style="font-size:11px; color:var(--muted); opacity:0; transition:opacity 0.3s;">Saved!</span>
                <button class="btn-primary" id="save-notes-btn">Save Notes</button>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <h3>Active Interviews</h3>
              <div class="status-text">Status: "Interview"</div>
            </div>
            <div class="list-container" id="interview-list">
              <p style="text-align:center; padding:20px; color:var(--muted); font-size:12px;">Loading interviews...</p>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <h3>AI Prep Bot</h3>
            </div>
            <div class="chat-container">
              <div class="chat-history" id="chat-history">
                <div class="bubble ai">Hi! I'm your interview coach. Select a role and I can help you generate questions or review your pitch.</div>
              </div>
              <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="Ask for tips...">
                <button class="btn-primary" id="chat-send">Send</button>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // SUPABASE CONFIG
    const supabaseUrl = "https://xktmvjnzjeeoxsreggpg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhrdG12am56amVlb3hzcmVnZ3BnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTEzMjMsImV4cCI6MjA4Mzk2NzMyM30.RHfnwflwiZ4KwDNLC_H6WpoekvHWAQeau5m8bTod2IM";
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let selectedAppId = null;

    // --- THEME & UI LOGIC (Matches Dashboard) ---
    const themeToggle = document.getElementById("themeToggle");
    const storedTheme = localStorage.getItem("applytrack-theme") || "dark";
    document.documentElement.setAttribute("data-theme", storedTheme);
    themeToggle.textContent = storedTheme === "dark" ? "üåô Dark" : "‚òÄÔ∏è Light";

    themeToggle.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("applytrack-theme", next);
      themeToggle.textContent = next === "dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
    });

    const sidebar = document.getElementById("sidebar");
    const sidebarBackdrop = document.getElementById("sidebarBackdrop");
    const menuToggle = document.getElementById("menuToggle");

    if (menuToggle) {
      menuToggle.addEventListener("click", () => {
        sidebar.classList.add("open");
        sidebarBackdrop.classList.add("visible");
      });
    }
    if (sidebarBackdrop) {
      sidebarBackdrop.addEventListener("click", () => {
        sidebar.classList.remove("open");
        sidebarBackdrop.classList.remove("visible");
      });
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    // --- MAIN LOGIC ---
    async function init() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = "login.html";
        return;
      }
      currentUser = data.session.user;
      
      if (currentUser.email) {
        document.getElementById("userEmail").textContent = currentUser.email;
        document.getElementById("userAvatar").textContent = currentUser.email[0].toUpperCase();
      }

      fetchInterviews();
    }

    // 1. Fetch applications where status == 'Interview'
    async function fetchInterviews() {
      const container = document.getElementById("interview-list");
      
      const { data, error } = await supabase
        .from("applications")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("status", "Interview") 
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        container.innerHTML = `<p style="text-align:center; color:red; padding:20px;">Error loading data.</p>`;
        return;
      }

      container.innerHTML = "";
      if (!data || data.length === 0) {
        container.innerHTML = `<p style="text-align:center; padding:20px; color:var(--muted); font-size:12px;">
          No active interviews found.<br><br>Move an application to the <strong>"Interview"</strong> column on the Board to see it here.
        </p>`;
        return;
      }

      data.forEach(app => {
        const div = document.createElement("div");
        div.className = "iv-card";
        div.dataset.id = app.id;
        div.innerHTML = `
          <div class="iv-company">${app.company}</div>
          <div class="iv-role">${app.role}</div>
          <div class="iv-meta">
             <span>üìÖ ${app.follow_up_date || "No date set"}</span>
             <span>üìç ${app.location || "Remote"}</span>
          </div>
        `;
        div.onclick = () => selectInterview(app, div);
        container.appendChild(div);
      });
    }

    // 2. Select Interview & Load Notes
    async function selectInterview(app, cardElement) {
      selectedAppId = app.id;
      
      document.querySelectorAll(".iv-card").forEach(c => c.classList.remove("active"));
      cardElement.classList.add("active");
      
      document.getElementById("active-header-sub").textContent = `Notes for ${app.company} ‚Äì ${app.role}`;
      document.getElementById("notes-status").textContent = "Editing: " + app.company;
      document.getElementById("notes-textarea").value = "Loading...";

      // Fetch Note from application_notes table using application_id
      const { data, error } = await supabase
        .from("application_notes")
        .select("notes")
        .eq("application_id", app.id)
        .maybeSingle(); // Changed to maybeSingle to avoid errors if no note exists yet

      if (error) {
        console.error("Error fetching notes:", error);
      }

      document.getElementById("notes-textarea").value = data ? data.notes : "";
    }

    // 3. Save Notes (Updated to "Check then Write" to avoid upsert errors)
    document.getElementById("save-notes-btn").addEventListener("click", async () => {
      if (!selectedAppId) {
        alert("Please select an interview from the list first.");
        return;
      }

      const noteText = document.getElementById("notes-textarea").value;
      const feedback = document.getElementById("save-feedback");
      feedback.style.opacity = "0";

      // Step 1: Check if a note row already exists for this application
      const { data: existingNote, error: fetchError } = await supabase
        .from("application_notes")
        .select("id")
        .eq("application_id", selectedAppId)
        .maybeSingle();

      if (fetchError) {
        console.error(fetchError);
        alert("Error checking for existing notes: " + fetchError.message);
        return;
      }

      let error;

      // Step 2: If exists -> Update. If not -> Insert.
      if (existingNote) {
        // Update existing row
        const result = await supabase
          .from("application_notes")
          .update({ 
            notes: noteText,
            updated_at: new Date().toISOString()
          })
          .eq("id", existingNote.id);
        error = result.error;
      } else {
        // Insert new row
        const result = await supabase
          .from("application_notes")
          .insert([{ 
            user_id: currentUser.id,
            application_id: selectedAppId, 
            notes: noteText,
            // stage: 'Interview' // Optional: if your DB requires the 'stage' column, uncomment this
          }]);
        error = result.error;
      }

      if (error) {
        console.error(error);
        alert("Error saving notes: " + error.message + "\n\n(Tip: Check if RLS policies are enabled for 'application_notes' table in Supabase!)");
      } else {
        feedback.textContent = "Saved at " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        feedback.style.opacity = "1";
      }
    });

    // 4. Simple Chatbot UI
    document.getElementById("chat-send").addEventListener("click", () => {
      const input = document.getElementById("chat-input");
      const history = document.getElementById("chat-history");
      const text = input.value.trim();
      if (!text) return;

      const userBubble = document.createElement("div");
      userBubble.className = "bubble user";
      userBubble.textContent = text;
      history.appendChild(userBubble);
      
      input.value = "";
      history.scrollTop = history.scrollHeight;

      setTimeout(() => {
        const aiBubble = document.createElement("div");
        aiBubble.className = "bubble ai";
        if (selectedAppId) {
          aiBubble.textContent = "That's a great question. Since you are applying for this role, focus on highlighting your specific experience with " + text; 
        } else {
          aiBubble.textContent = "Please select an interview from the list first so I can give you specific advice!";
        }
        history.appendChild(aiBubble);
        history.scrollTop = history.scrollHeight;
      }, 600);
    });

    init();
  </script>
</body>
</html>
